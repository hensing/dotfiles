#!/usr/bin/python
# coding: utf-8
"""
    small script to find and open a paper via regular expression
"""
__author__ = 'Henning Dickten'


import argparse
import re
import os
import sys
import fnmatch
import subprocess

PATH = '/media/freenas/pappos'
EXE = '/usr/bin/acroread'


def parse_args(argv=None):
    """
    Parser für die Console
    """
    if argv is None:
        argv = sys.argv

    parser = argparse.ArgumentParser()

    parser.add_argument('regex', metavar='regex', nargs='+',
                        help='search expression')

    parser.add_argument('-m', '--mendeley', dest='mendeley',
                        action='store_true',
                        help='open in Mendeley Desktop')

    parser.add_argument('-r', '--raw', dest='raw',
                        action='store_true',
                        help='use raw expression (without additional *)')

    args = parser.parse_args()
    return args


def find_paper(expressions, exe, use_raw=False):
    """
    Finds all files matching on expression
    """
    results = []

    for expression in expressions:
        if use_raw is False:
            expression = expression.strip('*') + '*'

        reg_expr = re.compile(fnmatch.translate(expression), re.IGNORECASE)

        for root, _, files in os.walk(PATH, topdown=True):
            results += [os.path.join(root, i) for
                       i in files if re.match(reg_expr, i)]

    if len(results) == 0:
        print('ERROR nothing found for "{}"\n'.format(' ∨ '.join(expressions)))
        sys.exit(0)
    results.sort()

    print('Results for "{}:"\n'.format(' ∨ '.join(expressions)))
    for res_num, res in enumerate(results):
        print('{: >4}: {}'.format(res_num + 1, res.lstrip(PATH)))

    selected = raw_input('select paper or \'q\' to quit> ')

    if selected == 'q':
        sys.exit(0)

    else:
        # escape fname
        fname = '"{}"'.format(results[int(selected) - 1])
        print fname
        subprocess.Popen(exe + ' ' + fname, shell=True)

if __name__ == '__main__':
    ARGS = parse_args()
    if ARGS.mendeley is True:
        EXE = '/usr/bin/mendeleydesktop'
    find_paper(ARGS.regex, EXE, ARGS.raw)
